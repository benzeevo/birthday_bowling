<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××™××•×Ÿ ×”×‘××•×œ×™× ×’ ×©×œ ×”××œ×•×¤×™×!</title>
    <style>
        body {
            /* ×¨×§×¢ ×‘×¡×’× ×•×Ÿ ××¡×™×‘×ª × ×™××•×Ÿ ×›×”×” */
            background: linear-gradient(rgba(26, 0, 51, 0.85), rgba(0, 0, 0, 0.9)),
                        url('https://images.unsplash.com/photo-1523540737048-2679d0177306?q=80&w=1920&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden; /* ×× ×™×¢×ª ×’×œ×™×œ×” */
            touch-action: none; /* ×‘×™×˜×•×œ ××—×•×•×ª ×“×¤×“×¤×Ÿ ×œ×˜×•×‘×ª ×”××©×—×§ */
            position: fixed; /* ×§×™×‘×•×¢ ×”××¡×š ×œ×× ×™×¢×ª ×’×œ×™×œ×” ×‘××™×™×¤×•×Ÿ */
            width: 100%;
            height: 100%;
        }
        h1 { 
            color: #ffcc00; 
            text-shadow: 0 0 15px #ff6600, 2px 2px 4px #000; /* ××¤×§×˜ ×–×•×”×¨ */
            margin-bottom: 5px;
            font-size: 28px;
            white-space: nowrap; /* ×× ×™×¢×ª ×©×‘×™×¨×ª ×©×•×¨×” */
        }
        h2 { 
            color: #00d2ff; 
            text-shadow: 0 0 10px #0056b3;
            margin-top: 0;
            font-size: 20px;
            white-space: nowrap; /* ×× ×™×¢×ª ×©×‘×™×¨×ª ×©×•×¨×” */
        }
        #game-container {
            position: relative;
            width: 340px;
            height: 500px;
            /* ××¡×œ×•×œ ×¢×¥ ×¨×™××œ×™×¡×˜×™ */
            background: 
                linear-gradient(90deg, #111 25px, transparent 25px, transparent 315px, #111 315px),
                linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 100%),
                repeating-linear-gradient(90deg, #8b5a2b 0px, #8b5a2b 28px, #5c3a1e 29px, #5c3a1e 30px);
            border: 4px solid #ffcc00;
            border-radius: 10px;
            overflow: hidden;
            /* ×”×™×œ×” ×–×•×”×¨×ª ××¡×‘×™×‘ ×œ××¡×œ×•×œ */
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.3), 0 10px 20px rgba(0,0,0,0.5);
        }
        .pin {
            position: absolute;
            width: 30px;
            height: 60px;
            background-color: #f0f0f0;
            border-radius: 50% 50% 10% 10% / 30% 30% 10% 10%;
            border: 2px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        .pin::after { /* ×¤×¡ ××“×•× ×–×•×”×¨ */
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: red;
            box-shadow: 0 0 5px red;
        }
        .pin.fallen {
            /* Transform is handled in JS for randomness */
            opacity: 0.7;
            pointer-events: none;
        }
        .pin.cleared {
            opacity: 0;
            transform: scale(0);
            transition: all 0.5s ease-in;
        }
        #ball {
            position: absolute;
            top: 430px;
            left: 145px; /* ×××¦×¢ */
            width: 50px;
            height: 50px;
            /* ×›×“×•×¨ ××‘×¨×™×§ */
            background: radial-gradient(circle at 30% 30%, #00ffff, #0056b3);
            border-radius: 50%;
            box-shadow: 0 0 15px #00d2ff, 0 5px 15px rgba(0,0,0,0.4);
            touch-action: none; /* ××•× ×¢ ×’×œ×™×œ×” ×‘××•×‘×™×™×œ */
            cursor: grab;
            background-size: cover;
        }
        #ball:active {
            cursor: grabbing;
        }
        #controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .buttons-row {
            display: flex;
            flex-direction: row;
            gap: 10px;
            align-items: center;
        }
        .small-buttons-col {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #settings-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            font-size: 24px;
            padding: 8px 12px;
            margin: 0;
            background: rgba(0, 0, 0, 0.5);
            box-shadow: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }
        button {
            background: linear-gradient(to bottom, #ffcc00, #ffaa00);
            border: none;
            color: #222;
            padding: 15px 40px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 24px;
            font-weight: bold;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.5), 0 4px #999;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            transition: 0.1s;
             -webkit-tap-highlight-color: transparent;
        }
        button:active {
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.3), 0 2px #666;
            transform: translateY(2px);
        }
        button:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            box-shadow: none;
            text-shadow: none;
            transform: none;
        }
        #score-display {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
            color: #ffcc00;
            text-shadow: 0 0 10px #ff6600;
            transition: transform 0.2s;
        }
        #message {
            position: absolute;
            top: 150px;
            width: 100%;
            z-index: 30;
            pointer-events: none;
            font-weight: bold;
            color: #ff6666;
            font-size: 20px;
            text-shadow: 1px 1px 2px #000;
            transition: all 0.3s;
        }
        .celebration {
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 36px !important;
            color: #fff !important;
            text-shadow: 0 0 20px #ff00de, 0 0 40px #ff00de !important;
            z-index: 10;
        }
        @keyframes popIn {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            80% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0); }
        }
        .motivation {
            animation: pulse 1.5s infinite;
            color: #adff2f !important; /* Green-yellow for encouragement */
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        #high-score {
            font-size: 18px;
            color: #00ffcc;
            margin: 0;
            text-shadow: 0 0 5px #000;
        }
        .stats-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px;
            flex-wrap: wrap;
            width: 100%;
        }
        #diamonds-display { color: #00ffff; font-size: 18px; font-weight: bold; text-shadow: 0 0 5px #000; }
        #coins-display { color: #ffd700; font-size: 18px; font-weight: bold; text-shadow: 0 0 5px #000; }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 100;
        }
        @keyframes fall {
            to { transform: translateY(500px) rotate(720deg); opacity: 0; }
        }
        .lane-arrow {
            position: absolute;
            width: 0; 
            height: 0; 
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 20px solid rgba(255, 255, 255, 0.3);
            top: 300px;
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        #power-bar-container {
            position: absolute;
            right: 10px;
            top: 150px;
            width: 20px;
            height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff;
            border-radius: 10px;
            overflow: hidden;
            display: none;
            z-index: 20;
        }
        #power-bar-fill {
            width: 100%;
            height: 0%;
            background: linear-gradient(to top, #00ff00, #ffff00, #ff0000);
            position: absolute;
            bottom: 0;
        }
        .spark {
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 20;
            animation: spark-anim 0.5s linear forwards;
        }
        #drag-arrow {
            position: absolute;
            width: 0; 
            height: 0; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 60px solid rgba(255, 255, 0, 0.8);
            transform-origin: bottom center;
            pointer-events: none;
            display: none;
            z-index: 15;
            filter: drop-shadow(0 0 8px #ff0000);
        }
        #reset-score-btn {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            border: none;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            margin: 0;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        #reset-score-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.5);
        }
        #reset-score-btn:active {
            transform: translateY(1px);
        }
        #oil-pattern {
            font-size: 14px;
            color: #aaaaff;
            margin: 5px;
            text-shadow: 0 0 5px #0000ff;
            font-weight: bold;
            display: none; /* Default hidden */
        }
        #difficulty-level {
            font-size: 14px;
            color: #ffff00;
            margin: 5px;
            text-shadow: 0 0 5px #ff6600;
            font-weight: bold;
            cursor: pointer;
        }
        .settings-row {
            display: flex;
            flex-direction: row;
            gap: 15px;
            justify-content: center;
            width: 100%;
        }
        #replay-btn {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #fff;
            color: #fff;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            cursor: pointer;
            margin: 0;
            display: none; /* Hidden initially */
        }
        #replay-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        /* ×”×ª×××” ×œ××¡×›×™× ×§×˜× ×™× */
        @media (max-height: 700px) {
            h1 { font-size: 18px; margin-bottom: 2px; }
            h2 { font-size: 14px; margin-top: 0; margin-bottom: 2px; }
            #score-display { font-size: 18px; margin: 2px; }
            #high-score { font-size: 14px; }
            #message { font-size: 16px; height: 20px; }
            #controls { margin-top: 0; }
            button { padding: 8px 20px; font-size: 16px; }
            #game-container {
                transform: scale(0.75);
                transform-origin: top center;
                margin-bottom: -125px; /* ×¤×™×¦×•×™ ×¢×œ ×”×§×˜× ×ª ×”×’×•×“×œ */
            }
            #countdown { font-size: 14px; padding: 4px 8px; margin-top: 2px; }
        }
        .trail-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            pointer-events: none;
            animation: fadeOut 0.6s linear forwards;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.6);
        }
        @keyframes spark-anim {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: scale(0.2); }
        }
        #countdown {
            font-family: 'Courier New', Courier, monospace;
            background-color: #000;
            color: #0f0;
            padding: 8px 15px;
            border: 3px solid #333;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 5px #0f0;
            margin-top: 10px;
            margin-bottom: 5px;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
            display: flex;
            gap: 5px;
            z-index: 100;
            direction: ltr; /* Ensure numbers are LTR */
        }
        .time-unit {
            min-width: 25px;
            text-align: center;
        }
        #overlay-message {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s;
        }
        #overlay-message.visible {
            opacity: 1;
            pointer-events: all;
        }
        #overlay-text {
            font-size: 50px;
            color: #ffcc00;
            text-shadow: 0 0 20px #ff6600, 0 0 40px #ff0000;
            text-align: center;
            animation: pulseText 1s infinite alternate;
            margin: 20px;
        }
        @keyframes pulseText {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.8); 
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #222;
            border: 2px solid #ffcc00;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 350px;
            color: white;
            text-align: right;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 204, 0, 0.3);
        }
        .close-btn {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover { color: white; }
        .setting-group { margin-bottom: 15px; }
        .setting-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #ffcc00; }
        .setting-group select { width: 100%; padding: 8px; border-radius: 5px; background: #333; color: white; border: 1px solid #555; }
        
        /* Texture Options */
        .texture-options { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .texture-option {
            width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 2px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .texture-option.selected { border-color: #ffcc00; transform: scale(1.1); }
        
        /* Ball Textures (CSS Only) */
        .ball-basketball {
            background-color: #ff6600 !important;
            background-image: 
                radial-gradient(circle, transparent 59%, #000 60%, #000 64%, transparent 65%),
                linear-gradient(to right, transparent 48%, #000 48%, #000 52%, transparent 52%) !important;
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.5) !important;
        }
        .ball-football {
            background-color: #fff !important;
            background-image: 
                radial-gradient(circle at 50% 50%, #000 20%, transparent 21%),
                radial-gradient(circle at 10% 10%, #000 15%, transparent 16%),
                radial-gradient(circle at 90% 90%, #000 15%, transparent 16%) !important;
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.3) !important;
        }
        .ball-tennis {
            background-color: #ccff00 !important;
            background-image: radial-gradient(circle at 50% 50%, transparent 60%, white 61%, white 65%, transparent 66%) !important;
            transform: rotate(45deg);
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.3) !important;
        }
        .ball-baseball {
            background-color: #fff !important;
            background-image: 
                radial-gradient(circle at 30% 50%, transparent 55%, #f00 56%, #f00 58%, transparent 59%),
                radial-gradient(circle at 70% 50%, transparent 55%, #f00 56%, #f00 58%, transparent 59%) !important;
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.3) !important;
        }

        /* Themes */
        body.theme-light {
            background: #f0f0f0;
            color: #333;
        }
        body.theme-light h1 { color: #d35400; text-shadow: none; }
        body.theme-light h2 { color: #2980b9; text-shadow: none; }
        body.theme-light #score-display { color: #d35400; text-shadow: none; }
        body.theme-light .modal-content { background: #fff; color: #333; border-color: #d35400; }
        body.theme-light .setting-group label { color: #d35400; }
        body.theme-light select { background: #eee; color: #333; border-color: #ccc; }
        body.theme-light #game-container { border-color: #d35400; background: linear-gradient(to bottom, #e6b800, #806600); }

        body.theme-dark {
            background: #121212;
            color: #e0e0e0;
        }
        body.theme-dark h1 { color: #bb86fc; text-shadow: 0 0 5px #3700b3; }
        body.theme-dark h2 { color: #03dac6; text-shadow: none; }
        body.theme-dark #game-container { border-color: #bb86fc; background: linear-gradient(to bottom, #333, #111); }
        body.theme-dark .modal-content { background: #1e1e1e; border-color: #bb86fc; }
        body.theme-dark .setting-group label { color: #bb86fc; }

        body.theme-retro {
            background: linear-gradient(to bottom, #2c003e, #000);
            color: #0ff;
        }
        body.theme-retro h1 { color: #f0f; text-shadow: 2px 2px 0px #0ff; font-family: 'Courier New', Courier, monospace; }
        body.theme-retro #game-container { 
            border-color: #0ff; 
            background: repeating-linear-gradient(0deg, transparent 0, transparent 19px, #f0f 20px),
                        linear-gradient(to bottom, #2c003e, #000);
        }
        body.theme-retro .modal-content { background: #000; border: 2px solid #0ff; color: #f0f; }
        body.theme-retro .setting-group label { color: #0ff; }
        }
    </style>
</head>
<body>

    <div id="overlay-message">
        <h1 id="overlay-text"></h1>
    </div>
    <button id="settings-btn">âš™ï¸</button>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-settings">&times;</span>
            <h2>âš™ï¸ ×”×’×“×¨×•×ª</h2>
            
            <div class="setting-group">
                <label>×¨××ª ×§×•×©×™:</label>
                <select id="setting-difficulty">
                    <option value="easy">×§×œ</option>
                    <option value="medium" selected>×‘×™× ×•× ×™</option>
                    <option value="hard">×§×©×”</option>
                </select>
            </div>

            <div class="setting-group">
                <label>×¢×¨×›×ª × ×•×©×:</label>
                <select id="setting-theme">
                    <option value="standard" selected>× ×™××•×Ÿ (×¨×’×™×œ)</option>
                    <option value="light">×‘×”×™×¨</option>
                    <option value="dark">×›×”×”</option>
                    <option value="retro">×¨×˜×¨×• 80s</option>
                </select>
            </div>

            <div class="setting-group">
                <label>×ª×¦×•×’×ª ××¦×‘ ×©××Ÿ:</label>
                <select id="setting-oil-display">
                    <option value="hide" selected>××•×¡×ª×¨</option>
                    <option value="show">××•×¦×’</option>
                </select>
            </div>

            <div class="setting-group">
                <label>×¡××•× ×“:</label>
                <select id="setting-sound">
                    <option value="on" selected>×¤×¢×™×œ</option>
                    <option value="off">××•×©×ª×§</option>
                </select>
            </div>

            <div class="setting-group">
                <label>×¢×™×¦×•×‘ ×›×“×•×¨:</label>
                <div class="texture-options" id="texture-options">
                    <!-- Options generated by JS or static -->
                    <div class="texture-option selected" data-texture="standard" style="background: radial-gradient(circle at 30% 30%, #00ffff, #0056b3);"></div>
                    <div class="texture-option" data-texture="basketball" style="background-color: #ff6600;"></div>
                    <div class="texture-option" data-texture="football" style="background-color: #fff; border: 1px solid #ccc;"></div>
                    <div class="texture-option" data-texture="tennis" style="background-color: #ccff00;"></div>
                    <div class="texture-option" data-texture="baseball" style="background-color: #fff; border: 1px solid #ccc;"></div>
                </div>
            </div>
            
            <button id="reset-score-btn" style="width: 100%; margin-top: 10px;">ğŸ—‘ï¸ ××™×¤×•×¡ ×©×™×</button>
            <button id="reset-stats-btn" style="width: 100%; margin-top: 10px; background: linear-gradient(45deg, #4444ff, #0000cc);">ğŸ—‘ï¸ ××™×¤×•×¡ ×™×”×œ×•××™×/××˜×‘×¢×•×ª</button>
        </div>
    </div>

    <div id="countdown">
        <span id="cd-days" class="time-unit">00</span>d :
        <span id="cd-hours" class="time-unit">00</span>h :
        <span id="cd-minutes" class="time-unit">00</span>m :
        <span id="cd-seconds" class="time-unit">00</span>s
    </div>

    <h1>ğŸ’¥ ××™××•×Ÿ ×‘××•×œ×™× ×’! ğŸ’¥</h1>
    <h2>×™×•× ×ª×Ÿ ×‘.×– | ×™×•× ×ª×Ÿ ×¢. | ×™×•×ª× ×›.</h2>
    
    <div class="stats-bar">
        <div id="score-display">× ×™×§×•×“: 0</div>
        <div id="coins-display">ğŸª™ 0</div>
        <div id="diamonds-display">ğŸ’ 0</div>
        <div id="high-score">×©×™×: 0</div>
    </div>

    <div id="game-container">
        <div id="message">×’×¨×¨×• ××ª ×”×›×“×•×¨ ×•×–×¨×§×•!</div>
        <div id="ball"></div>
        <div id="drag-arrow"></div>
    </div>

    <div id="controls">
        <div id="oil-pattern">×ª×‘× ×™×ª ×©××Ÿ: ×¨×’×™×œ</div>
        <div class="buttons-row">
            <button id="action-btn">×”××ª×Ÿ...</button>
            <div class="small-buttons-col">
                <button id="replay-btn">ğŸ”„ ×”×™×œ×•×š ×—×•×–×¨</button>
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        const ball = document.getElementById('ball');
        const gameContainer = document.getElementById('game-container');
        const dragArrow = document.getElementById('drag-arrow');
        const actionBtn = document.getElementById('action-btn');
        const messageDisplay = document.getElementById('message');
        const scoreDisplay = document.getElementById('score-display');
        const highScoreDisplay = document.getElementById('high-score');
        const resetScoreBtn = document.getElementById('reset-score-btn');
        const resetStatsBtn = document.getElementById('reset-stats-btn');
        const oilPatternDisplay = document.getElementById('oil-pattern');
        const replayBtn = document.getElementById('replay-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings');
        const settingDifficulty = document.getElementById('setting-difficulty');
        const settingTheme = document.getElementById('setting-theme');
        const settingOilDisplay = document.getElementById('setting-oil-display');
        const settingSound = document.getElementById('setting-sound');
        const textureOptions = document.querySelectorAll('.texture-option');
        const diamondsDisplay = document.getElementById('diamonds-display');
        const coinsDisplay = document.getElementById('coins-display');

        let currentThrow = 1;
        let ballPosition = 145; // ××¨×›×–
        let ballDirection = 1; // 1 ×™××™× ×”, -1 ×©×××œ×”
        const ballSpeed = 4; // ××”×™×¨×•×ª ×ª×–×•×–×”
        let ballRollSpeed = 9; // ××”×™×¨×•×ª ×’×œ×’×•×œ ×× ×›×™×ª
        let currentPower = 0;
        let powerDirection = 3;
        let curveAmount = 0;
        let currentOilFactor = 1.0;
        let currentDifficulty = 'medium';
        let isMuted = false;
        let currentBallTexture = 'standard';
        let gameState = 'aiming'; // ××¦×‘×™ ××©×—×§: aiming, setting_power, rolling, finished
        let pins = [];
        let score = 0;
        let animationId; // ××–×”×” ×”×× ×™××¦×™×”
        let pinsFallenInCurrentThrow = 0; // ××¢×§×‘ ××—×¨×™ × ×¤×™×œ×•×ª ×‘×–×¨×™×§×” ×”× ×•×›×—×™×ª
        let birthdayCelebrated = false; // ×“×’×œ ×œ×—×’×™×’×ª ×™×•× ×”×•×œ×“×ª
        let diamonds = 0;
        let coins = 0;
        
        // ××©×ª× ×™ ×”×™×œ×•×š ×—×•×–×¨
        let recordedFrames = [];
        let isReplaying = false;
        let replayIndex = 0;
        let savedGameState = null; // ×œ×©××™×¨×ª ××¦×‘ ×”×œ×•×— ×œ×¤× ×™ ×”×¨×™×¤×œ×™×™

        // ××©×ª× ×™ Swipe
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let lastDragX = 0;
        let lastDragY = 0;
        let lastDragTime = 0;
        let velocityX = 0;
        let velocityY = 0;

        // ×˜×¢×™× ×ª ×©×™×
        let highScore = localStorage.getItem('bowlingHighScore') || 0;
        highScoreDisplay.textContent = "×©×™×: " + highScore;

        // ×˜×¢×™× ×ª ××˜×‘×¢×•×ª ×•×™×”×œ×•××™×
        diamonds = parseInt(localStorage.getItem('bowlingDiamonds')) || 0;
        coins = parseInt(localStorage.getItem('bowlingCoins')) || 0;
        updateCurrencyDisplay();

        function updateCurrencyDisplay() {
            diamondsDisplay.textContent = "ğŸ’ " + diamonds;
            coinsDisplay.textContent = "ğŸª™ " + coins;
        }

        const difficultySettings = {
            easy: { name: '×§×œ', hitRadius: 50, fallProbDivisor: 70, chainReactionProb: 0.8, curveMultiplier: 0.7, color: '#00ff00' },
            medium: { name: '×‘×™× ×•× ×™', hitRadius: 40, fallProbDivisor: 50, chainReactionProb: 0.5, curveMultiplier: 1.0, color: '#ffff00' },
            hard: { name: '×§×©×”', hitRadius: 30, fallProbDivisor: 35, chainReactionProb: 0.2, curveMultiplier: 1.5, color: '#ff0000' }
        };

        // --- Settings Logic ---
        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.style.display = 'none';
            }
        });

        settingDifficulty.addEventListener('change', (e) => {
            currentDifficulty = e.target.value;
        });

        settingTheme.addEventListener('change', (e) => {
            document.body.className = ''; // Clear existing themes
            if (e.target.value !== 'standard') {
                document.body.classList.add('theme-' + e.target.value);
            }
        });

        settingOilDisplay.addEventListener('change', (e) => {
            if (oilPatternDisplay) {
                oilPatternDisplay.style.display = e.target.value === 'show' ? 'block' : 'none';
            }
        });

        settingSound.addEventListener('change', (e) => {
            isMuted = e.target.value === 'off';
        });

        textureOptions.forEach(opt => {
            opt.addEventListener('click', () => {
                // Remove selected class from all
                textureOptions.forEach(o => o.classList.remove('selected'));
                // Add to clicked
                opt.classList.add('selected');
                
                currentBallTexture = opt.dataset.texture;
                applyBallTexture();
            });
        });

        // ××™×¤×•×¡ ×©×™×
        resetScoreBtn.addEventListener('click', () => {
            if (confirm("×”×× ×œ××¤×¡ ××ª ×”×©×™×?")) {
                localStorage.removeItem('bowlingHighScore');
                highScore = 0;
                highScoreDisplay.textContent = "×©×™×: 0";
                highScoreDisplay.style.color = "#00ffcc";
            }
        });

        // ××™×¤×•×¡ ×¡×˜×˜×™×¡×˜×™×§×”
        resetStatsBtn.addEventListener('click', () => {
            if (confirm("×”×× ×œ××¤×¡ ××ª ××•× ×” ×”×™×”×œ×•××™× ×•×”××˜×‘×¢×•×ª?")) {
                diamonds = 0;
                coins = 0;
                localStorage.setItem('bowlingDiamonds', 0);
                localStorage.setItem('bowlingCoins', 0);
                updateCurrencyDisplay();
            }
        });

        // ×›×¤×ª×•×¨ ×”×™×œ×•×š ×—×•×–×¨
        replayBtn.addEventListener('click', () => {
            startReplay();
        });

        // --- ××¢×¨×›×ª ×¡××•× ×“ (×œ×œ× ×§×‘×¦×™× ×—×™×¦×•× ×™×™×) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (isMuted) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            
            if (type === 'throw') {
                // ×¦×œ×™×œ "×•×•×•×©" ×™×•×¨×“
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.5);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'hit') {
                // ×¦×œ×™×œ ××›×” × ××•×š
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(40, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'win') {
                // ××§×•×¨×“ × ×™×¦×—×•×Ÿ
                playNote(523.25, now, 0.1); // C5
                playNote(659.25, now + 0.1, 0.1); // E5
                playNote(783.99, now + 0.2, 0.4); // G5
            }
        }
        function playNote(freq, time, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.2, time);
            gain.gain.linearRampToValueAtTime(0, time + duration);
            osc.start(time);
            osc.stop(time + duration);
        }

        // --- ×”×’×“×¨×ª ×”××©×—×§ ---

        // ×™×¦×™×¨×ª ×”×¤×™× ×™×
        function setupPins() {
            // × ×™×§×•×™ ×¤×™× ×™× ×™×©× ×™×
            pins.forEach(pin => pin.element.remove());
            pins = [];
            
            const startX = 110; // × ×§×•×“×ª ×”×ª×—×œ×” ××•×¤×§×™×ª
            const startY = 50;  // × ×§×•×“×ª ×”×ª×—×œ×” ×× ×›×™×ª
            
            // ××¢×¨×š ××™×§×•××™× ×©×œ ×”×¤×™× ×™× (××©×•×œ×©)
            const pinRows = [
                [{x:0, y:0}, {x:60, y:0}, {x:120, y:0}], // ×©×•×¨×” 1 (××—×•×¨×™×ª)
                [{x:30, y:40}, {x:90, y:40}],           // ×©×•×¨×” 2
                [{x:60, y:80}]                          // ×©×•×¨×” 3 (×§×“××™×ª)
            ];

            // ×™×¦×™×¨×ª ×”××œ×× ×˜×™× ×‘×¤×•×¢×œ
            pinRows.forEach(row => {
                row.forEach(pos => {
                    createPin(startX + pos.x, startY + pos.y);
                });
            });
            
            // ×”×•×¡×¤×ª ×—×¦×™× ×œ××¡×œ×•×œ (×¤×¢× ××—×ª)
            if (!document.querySelector('.lane-arrow')) {
                const arrowPositions = [170, 140, 200, 110, 230, 80, 260];
                arrowPositions.forEach((left, index) => {
                    if (index > 6) return;
                    const arrow = document.createElement('div');
                    arrow.className = 'lane-arrow';
                    arrow.style.left = (left - 10) + 'px'; // Center adjustment
                    // ×¡×™×“×•×¨ ×‘×¦×•×¨×ª V
                    arrow.style.top = (300 - Math.abs(170 - left) * 0.5) + 'px';
                    gameContainer.appendChild(arrow);
                });
            }
        }

        // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×™×¦×™×¨×ª ×¤×™×Ÿ ×‘×•×“×“
        function createPin(x, y) {
            const pin = document.createElement('div');
            pin.className = 'pin';
            pin.style.left = x + 'px';
            pin.style.top = y + 'px';
            gameContainer.appendChild(pin);
            // ×©××™×¨×ª ×”××™×“×¢ ×¢×œ ×”×¤×™×Ÿ ×‘××¢×¨×š
            pins.push({ element: pin, x: x, y: y, fallen: false });
        }

        // --- ×× ×•×¢ ×”××©×—×§ ---

        // ×œ×•×œ××ª ×”×× ×™××¦×™×” ×”×¨××©×™×ª - ×¨×¦×” ×›×œ ×”×–××Ÿ
        function gameLoop() {
            if (gameState === 'aiming') {
                // ×‘××¦×‘ Swipe, ×”×›×“×•×¨ ×œ× ×–×– ×œ×‘×“. ×”××©×ª××© ××–×™×– ××•×ª×•.
                // ×¨×§ ××•×•×“××™× ×’×‘×•×œ×•×ª
                if (ballPosition > 290) ballPosition = 290;
                if (ballPosition < 0) ballPosition = 0;
                ball.style.left = ballPosition + 'px';

            } else if (gameState === 'replaying') {
                // ×œ×•×’×™×§×ª ×”×™×œ×•×š ×—×•×–×¨
                if (replayIndex < recordedFrames.length) {
                    const frame = recordedFrames[replayIndex];
                    
                    // ×©×—×–×•×¨ ××¦×‘ ×›×“×•×¨
                    ball.style.left = frame.ball.left;
                    ball.style.top = frame.ball.top;
                    ball.style.transform = frame.ball.transform;

                    // ×©×—×–×•×¨ ××¦×‘ ×¤×™× ×™×
                    frame.pins.forEach((pState, i) => {
                        if (pins[i]) {
                            pins[i].element.style.transform = pState.transform;
                            pins[i].element.className = pState.className;
                            pins[i].element.style.opacity = pState.opacity;
                        }
                    });

                    replayIndex++;
                } else {
                    endReplay();
                }

            } else if (gameState === 'rolling') {
                // ×©×œ×‘ ×”×’×œ×’×•×œ: ×”×–×–×ª ×”×›×“×•×¨ ×œ××¢×œ×”
                let currentTop = parseInt(ball.style.top);
                if (isNaN(currentTop)) currentTop = 430; // ×”×’× ×” ××¤× ×™ ×©×’×™××•×ª
                currentTop -= ballRollSpeed; // ××”×™×¨×•×ª ×”×›×“×•×¨ ××¢×œ×”
                
                ball.style.top = currentTop + 'px';

                // ×”×—×œ×ª ×¢×™×§×•×œ (Curve) ×‘×”×ª×× ×œ××”×™×¨×•×ª ×•×›×™×•×•×Ÿ
                ballPosition += curveAmount;
                // ×’×‘×•×œ×•×ª ×”××¡×œ×•×œ
                if (ballPosition < 0) ballPosition = 0;
                if (ballPosition > 290) ballPosition = 290;
                if (isNaN(ballPosition)) ballPosition = 145; // ×”×’× ×” ××¤× ×™ ×©×’×™××•×ª
                ball.style.left = ballPosition + 'px';

                // ×‘×“×™×§×ª ×”×ª× ×’×©×•×™×•×ª ×¨×¦×™×¤×”
                checkCollision(ballPosition + 25, currentTop + 25);

                // ×‘×“×™×§×” ×× ×”×›×“×•×¨ ×™×¦× ××”××¡×š (×¡×™×•× ×–×¨×™×§×”)
                if (currentTop < -60) {
                    handleThrowEnd();
                }

                // ××¤×§×˜ ×¤×¨×¡×¤×§×˜×™×‘×” ×•×¡×™×‘×•×‘ (3D)
                // ×›×›×œ ×©×”×›×“×•×¨ ×¢×•×œ×” ×œ××¢×œ×” (top ×§×˜×Ÿ), ×”×•× × ×”×™×” ×§×˜×Ÿ ×™×•×ª×¨
                let scale = 0.6 + (currentTop / 430) * 0.4; 
                ball.style.transform = `scale(${scale}) rotate(${(430 - currentTop) * 5}deg)`;

                // ××¤×§×˜ ×©×•×‘×œ (Trail)
                createTrail();

                // ×”×§×œ×˜×ª ×”×¤×¨×™×™× ×”× ×•×›×—×™
                const frame = {
                    ball: { left: ball.style.left, top: ball.style.top, transform: ball.style.transform },
                    pins: pins.map(p => ({
                        transform: p.element.style.transform,
                        className: p.element.className,
                        opacity: p.element.style.opacity
                    }))
                };
                recordedFrames.push(frame);
            }
            // ×‘×§×©×” ×œ×¤×¨×™×™× ×”×‘× ×©×œ ×”×× ×™××¦×™×”
            animationId = requestAnimationFrame(gameLoop);
        }

        // --- ×œ×•×’×™×§×ª ××©×—×§ ---

        // --- Swipe Controls ---
        function startDrag(e) {
            if (gameState !== 'aiming') return;
            if (e.cancelable) e.preventDefault(); // ×× ×™×¢×ª ×’×œ×™×œ×”
            messageDisplay.style.opacity = '0'; // ×”×¡×ª×¨×ª ×”×•×“×¢×” ×‘×’×¨×™×¨×”
            isDragging = true;
            
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            dragStartX = clientX;
            dragStartY = clientY;
            lastDragX = clientX;
            lastDragY = clientY;
            lastDragTime = Date.now();
            velocityX = 0;
            velocityY = 0;
        }

        function drag(e) {
            if (!isDragging) return;
            if (e.cancelable) e.preventDefault(); // ×× ×™×¢×ª ×’×œ×™×œ×” ×‘××•×‘×™×™×œ
            
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            // ×—×™×©×•×‘ ××”×™×¨×•×ª
            const now = Date.now();
            const dt = now - lastDragTime;
            if (dt > 0) {
                velocityX = (clientX - lastDragX) / dt;
                velocityY = (clientY - lastDragY) / dt;
            }
            lastDragX = clientX;
            lastDragY = clientY;
            lastDragTime = now;

            // ×”×–×–×ª ×”×›×“×•×¨ ××•×¤×§×™×ª (×’×¨×™×¨×”)
            // ×”××¨×” ××§×•××•×¨×“×™× ×˜×•×ª ××¡×š ×œ×§×•××•×¨×“×™× ×˜×•×ª ××©×—×§
            const containerRect = gameContainer.getBoundingClientRect();
            let newLeft = clientX - containerRect.left - 25; // 25 = half ball width
            ballPosition = newLeft;

            // ×”×–×–×ª ×”×›×“×•×¨ ×× ×›×™×ª (×›×“×™ ×©×™×¨×’×™×© ×›××• ×’×¨×™×¨×” ×××™×ª×™×ª)
            let newTop = clientY - containerRect.top - 25;
            // ×”×’×‘×œ×ª ×’×‘×•×œ×•×ª ×× ×›×™×™× ×›×“×™ ×©×œ× ×™×’×¨×¨×• ×¨×—×•×§ ××“×™
            if (newTop < 350) newTop = 350; 
            if (newTop > 450) newTop = 450;
            ball.style.top = newTop + 'px';

            // ×¢×“×›×•×Ÿ ×—×¥ ×”×›×™×•×•×Ÿ
            const speed = Math.sqrt(velocityX*velocityX + velocityY*velocityY);
            if (speed > 0.2) {
                const angle = Math.atan2(velocityY, velocityX);
                const degrees = angle * (180 / Math.PI) + 90;
                const scale = Math.min(speed / 3, 2.5); // ×”×’×‘×œ×ª ×’×•×“×œ ×”×—×¥
                
                dragArrow.style.display = 'block';
                dragArrow.style.left = (ballPosition + 25) + 'px';
                dragArrow.style.top = (newTop + 25) + 'px';
                dragArrow.style.transform = `translate(-50%, -100%) rotate(${degrees}deg) scaleY(${scale})`;
            } else {
                dragArrow.style.display = 'none';
            }
        }

        function endDrag(e) {
            if (!isDragging) return;
            isDragging = false;
            dragArrow.style.display = 'none';

            // ×–×™×”×•×™ "×¤×œ×™×§" (Swipe) - ××”×™×¨×•×ª ×× ×›×™×ª ×©×œ×™×œ×™×ª (×œ××¢×œ×”) ×•×—×–×§×” ××¡×¤×™×§
            if (velocityY < -0.3) {
                throwBall();
            } else {
                // ×× ×œ× ×”×™×™×ª×” ×–×¨×™×§×” ×—×–×§×” ××¡×¤×™×§, ×”×—×–×¨ ××ª ×”×›×“×•×¨ ×œ××§×•×
                ball.style.top = '430px';
            }
        }

        // ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×’×¨×™×¨×”
        ball.addEventListener('mousedown', startDrag);
        ball.addEventListener('touchstart', startDrag, {passive: false});
        document.addEventListener('mousemove', drag);
        document.addEventListener('touchmove', drag, {passive: false});
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchend', endDrag);

        function throwBall() {
            gameState = 'rolling';
            
            // ×—×™×©×•×‘ ×›×•×— ×•×¢×™×§×•×œ ×œ×¤×™ ×”-Swipe
            // ××”×™×¨×•×ª ××§×¡×™××œ×™×ª ×‘×¢×¨×š 15, ××™× ×™××œ×™×ª 5
            let speed = Math.abs(velocityY) * 10;
            if (isNaN(speed)) speed = 9; // ×”×’× ×” ××¤× ×™ NaN
            if (speed > 18) speed = 18;
            if (speed < 6) speed = 6;
            ballRollSpeed = speed;

            // ×›×™×•×•×Ÿ ×•×¢×™×§×•×œ ×œ×¤×™ ×ª× ×•×¢×” ××•×¤×§×™×ª
            // velocityX ×—×™×•×‘×™ = ×™××™× ×”, ×©×œ×™×œ×™ = ×©×××œ×”
            const diffSettings = difficultySettings[currentDifficulty];
            curveAmount = velocityX * 3 * currentOilFactor * diffSettings.curveMultiplier; 
            if (isNaN(curveAmount)) curveAmount = 0; // ×”×’× ×” ××¤× ×™ NaN

            pinsFallenInCurrentThrow = 0; // ××™×¤×•×¡ ××•× ×” × ×¤×™×œ×•×ª
            // ××™×¤×•×¡ ×”×§×œ×˜×”
            recordedFrames = [];
            replayBtn.style.display = 'none';
            messageDisplay.style.opacity = '1'; // ×”×—×–×¨×ª ×”×•×“×¢×” (×œ××©×œ "×‘×”×¦×œ×—×”")

            playSound('throw');
            messageDisplay.classList.remove('celebration');
            actionBtn.textContent = "×”×›×“×•×¨ ××ª×’×œ×’×œ...";
            actionBtn.disabled = true;
            messageDisplay.textContent = "×‘×”×¦×œ×—×”!";
        }

        function handleAction() {
            if (gameState === 'finished') {
                resetGame();
            }
        }

        // ×˜×™×¤×•×œ ×‘×œ×—×™×¦×” ×¢×œ ×”×›×¤×ª×•×¨
        actionBtn.addEventListener('click', handleAction);

        // ×˜×™×¤×•×œ ×‘××§×œ×“×ª (××§×© ×¨×•×•×—)
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && !actionBtn.disabled) {
                handleAction();
            }
        });

        // ×‘×“×™×§×ª ×¤×’×™×¢×” ×‘×¤×™× ×™×
        function checkCollision(ballCenterX, ballCenterY) {
            if (isNaN(ballCenterX) || isNaN(ballCenterY)) return;
            const settings = difficultySettings[currentDifficulty];

            let pinsHitFrame = 0;
            let pinsToKnock = [];
            
            // ×©×œ×‘ 1: ×–×™×”×•×™ ×¤×™× ×™× ×©×”×›×“×•×¨ ×¤×’×¢ ×‘×”× ×™×©×™×¨×•×ª
            pins.forEach(pin => {
                if (pin.fallen) return;

                const pinCenterX = pin.x + 15; // ××¨×›×– ×”×¤×™×Ÿ
                const pinCenterY = pin.y + 30; // ××¨×›×– ×”×¤×™×Ÿ ×× ×›×™×ª
                
                const dx = ballCenterX - pinCenterX;
                const dy = ballCenterY - pinCenterY;
                const distance = Math.sqrt(dx*dx + dy*dy); // ××¨×—×§ ××•×§×œ×™×“×™

                // ×× ××¨×›×– ×”×›×“×•×¨ ×§×¨×•×‘ ××¡×¤×™×§ ×œ××¨×›×– ×”×¤×™×Ÿ
                if (distance < settings.hitRadius) { 
                     // ×¡×™×›×•×™ ×œ×™×¤×•×œ ×ª×œ×•×™ ×‘××¨×—×§
                    if (Math.random() > (distance / settings.fallProbDivisor)) { 
                        pinsToKnock.push(pin);
                    }
                }
            });

            // ×©×œ×‘ 2: ×ª×’×•×‘×ª ×©×¨×©×¨×ª (×¤×™× ×™× ××¤×™×œ×™× ×¤×™× ×™×)
            let i = 0;
            while (i < pinsToKnock.length) {
                const currentPin = pinsToKnock[i];
                i++;

                if (currentPin.fallen) continue;

                // ×”×¤×œ×ª ×”×¤×™×Ÿ
                const angle = (Math.random() > 0.5 ? 90 : -90) + (Math.random() * 20 - 10);
                currentPin.element.style.transform = `rotate(${angle}deg) translate(${Math.random()*10}px, ${Math.random()*10}px)`;
                currentPin.element.classList.add('fallen');
                currentPin.fallen = true;
                pinsHitFrame++;
                playSound('hit');
                if (typeof createSparks === 'function') createSparks(currentPin.x + 15, currentPin.y + 30);

                // ×‘×“×™×§×” ×× ×”×¤×™×Ÿ ×”×–×” ××¤×™×œ ×©×›× ×™×
                pins.forEach(neighbor => {
                    if (neighbor.fallen || pinsToKnock.includes(neighbor)) return;

                    // ×—×™×©×•×‘ ××¨×—×§ ×‘×™×Ÿ ×”×¤×™×Ÿ ×©× ×¤×œ ×œ×©×›×Ÿ
                    const dx = currentPin.x - neighbor.x;
                    const dy = currentPin.y - neighbor.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);

                    // ×× ×”× ×§×¨×•×‘×™× (×©×›× ×™×), ×™×© ×¡×™×›×•×™ ×©×”×©×›×Ÿ ×™×™×¤×•×œ
                    if (dist < 70) {
                        // ×¡×™×›×•×™ ×’×‘×•×” ×œ×™×¤×•×œ ×× ×©×›×Ÿ × ×¤×œ ×¢×œ×™×š
                        if (Math.random() < settings.chainReactionProb) {
                            pinsToKnock.push(neighbor);
                        }
                    }
                });
            }

            // ×¢×“×›×•×Ÿ × ×™×§×•×“ ×•×”×•×“×¢×•×ª
            score += pinsHitFrame;
            pinsFallenInCurrentThrow += pinsHitFrame;
            scoreDisplay.textContent = "× ×™×§×•×“: " + score;
            
            // Score pop animation
            if (pinsHitFrame > 0) {
                scoreDisplay.style.transform = "scale(1.3)";
                // ×¨×¢×™×“×ª ××¡×š
                gameContainer.classList.add('shake');
                setTimeout(() => gameContainer.classList.remove('shake'), 500);
                
                setTimeout(() => scoreDisplay.style.transform = "scale(1)", 200);
            }
        }

        function handleThrowEnd() {
            const totalPins = 6;
            const totalFallen = pins.filter(p => p.fallen).length;

            if (currentThrow === 1 && totalFallen < totalPins) {
                gameState = 'clearing'; // Stop animation temporarily
                actionBtn.textContent = "×× ×§×” ××¡×œ×•×œ...";
                setTimeout(() => {
                    // Clear fallen pins
                    pins.forEach(p => {
                        if (p.fallen) p.element.classList.add('cleared');
                    });

                    currentThrow = 2;
                    gameState = 'aiming';
                    ball.style.top = '430px';
                    ballPosition = 145;
                    ballDirection = 1;
                    ball.style.left = ballPosition + 'px';
                    actionBtn.textContent = "×–×¨×•×§ ×›×“×•×¨ (2)!";
                    actionBtn.disabled = false;
                    replayBtn.style.display = 'block'; // ×”×¦×’×ª ×›×¤×ª×•×¨ ×¨×™×¤×œ×™×™
                    messageDisplay.textContent = "×™×© ×œ×š ×¢×•×“ ×”×–×“×× ×•×ª!";
                }, 1500);
            } else {
                gameState = 'finished';
                
                actionBtn.textContent = "ğŸ”„ ××©×—×§ ×—×“×©";
                actionBtn.disabled = false;
                replayBtn.style.display = 'block'; // ×”×¦×’×ª ×›×¤×ª×•×¨ ×¨×™×¤×œ×™×™
                
                if (totalFallen === totalPins) {
                    let bonus = 0;
                    if (currentThrow === 1) {
                        bonus = 50;
                        messageDisplay.textContent = "ğŸ”¥ STRIKE! (+50) ğŸ”¥";
                        diamonds++;
                        localStorage.setItem('bowlingDiamonds', diamonds);
                    } else {
                        bonus = 20;
                        messageDisplay.textContent = "âœ¨ SPARE! (+20) âœ¨";
                        coins++;
                        localStorage.setItem('bowlingCoins', coins);
                    }
                    updateCurrencyDisplay();
                    score += bonus;
                    scoreDisplay.textContent = "× ×™×§×•×“: " + score;
                    messageDisplay.classList.add('celebration');
                    playSound('win');
                    if (currentThrow === 1) fireConfetti(); // ××¤×§×˜ ×§×•× ×¤×˜×™ ×‘×¡×˜×¨×™×™×§
                } else {
                    const motivations = [
                        "×œ× × ×•×¨×, ×¤×¢× ×”×‘××”! ğŸ’ª",
                        "×›××¢×˜! ×ª××©×™×š ×œ×”×ª×××Ÿ! ğŸ¯",
                        "××©×—×§ ×˜×•×‘! × ×¡×” ×©×•×‘! ğŸš€",
                        "×”×™×™×ª ×§×¨×•×‘! ××œ×•×¤×™×! ğŸ†",
                        "×‘×¤×¢× ×”×‘××” ×¡×˜×¨×™×™×§! ğŸ˜‰"
                    ];
                    const randomMsg = motivations[Math.floor(Math.random() * motivations.length)];
                    messageDisplay.textContent = `× ×™×§×•×“: ${score}. ${randomMsg}`;
                    messageDisplay.classList.add('motivation');
                }

                // ×‘×“×™×§×ª ×©×™× ×—×“×©
                if (score > highScore) {
                    highScore = score;
                    localStorage.setItem('bowlingHighScore', highScore);
                    highScoreDisplay.textContent = "ğŸ† ×©×™×! " + highScore;
                    highScoreDisplay.style.color = "#ff00de"; // ×¦×‘×¢ ×—×’×™×’×™
                }
            }
        }

        function startReplay() {
            if (recordedFrames.length === 0) return;
            
            // ×©××™×¨×ª ××¦×‘ × ×•×›×—×™
            savedGameState = {
                gameState: gameState,
                ball: { left: ball.style.left, top: ball.style.top, transform: ball.style.transform },
                pins: pins.map(p => ({
                    transform: p.element.style.transform,
                    className: p.element.className,
                    opacity: p.element.style.opacity
                })),
                btnText: actionBtn.textContent,
                btnDisabled: actionBtn.disabled,
                msg: messageDisplay.textContent
            };

            gameState = 'replaying';
            replayIndex = 0;
            actionBtn.disabled = true;
            replayBtn.disabled = true;
            messageDisplay.textContent = "ğŸ¬ ×”×™×œ×•×š ×—×•×–×¨...";
        }

        function endReplay() {
            // ×©×—×–×•×¨ ××¦×‘
            if (savedGameState) {
                gameState = savedGameState.gameState;
                ball.style.left = savedGameState.ball.left;
                ball.style.top = savedGameState.ball.top;
                ball.style.transform = savedGameState.ball.transform;
                
                pins.forEach((p, i) => {
                    const saved = savedGameState.pins[i];
                    if (saved) {
                        p.element.style.transform = saved.transform;
                        p.element.className = saved.className;
                        p.element.style.opacity = saved.opacity;
                    }
                });

                actionBtn.textContent = savedGameState.btnText;
                actionBtn.disabled = savedGameState.btnDisabled;
                messageDisplay.textContent = savedGameState.msg;
            }
            replayBtn.disabled = false;
        }

        // ××™×¤×•×¡ ×”××©×—×§ ×œ×”×ª×—×œ×”
        function resetGame() {
            messageDisplay.classList.remove('celebration');
            messageDisplay.classList.remove('motivation');
            messageDisplay.style.opacity = '1';
            currentThrow = 1;
            gameState = 'aiming';
            ball.style.top = '430px';
            ballPosition = 145;
            ballDirection = 1;
            ball.style.transform = 'scale(1) rotate(0deg)'; // ××™×¤×•×¡ ×’×•×“×œ ×•×¡×™×‘×•×‘
            ball.style.left = ballPosition + 'px';
            applyBallTexture();
            setRandomOilPattern();
            actionBtn.textContent = "×’×¨×•×¨ ×•×–×¨×•×§!";
            actionBtn.disabled = true; // ×”×›×¤×ª×•×¨ ×œ× ×¤×¢×™×œ ×‘×–××Ÿ ××©×—×§ (×¨×§ Swipe)
            replayBtn.style.display = 'none';
            messageDisplay.textContent = "×’×¨×¨×• ××ª ×”×›×“×•×¨ ×•×–×¨×§×•!";
            score = 0;
            scoreDisplay.textContent = "× ×™×§×•×“: 0";
            highScoreDisplay.textContent = "×©×™×: " + highScore;
            highScoreDisplay.style.color = "#00ffcc"; // ×”×—×–×¨×ª ×¦×‘×¢ ×©×™× ×œ×¨×’×™×œ
            setupPins(); // ×™×¦×™×¨×” ××—×“×© ×©×œ ×”×¤×™× ×™×
        }

        function applyBallTexture() {
            // Reset classes and styles
            ball.className = ''; 
            ball.style.background = '';
            ball.style.boxShadow = '';

            if (currentBallTexture === 'standard') {
                setRandomBallColor();
            } else {
                ball.classList.add('ball-' + currentBallTexture);
            }
        }

        function setRandomBallColor() {
            // Only apply if standard texture is selected
            if (currentBallTexture !== 'standard') return;

            const palettes = [
                { main: '#00ffff', dark: '#0056b3', glow: '#00d2ff' }, // Cyan
                { main: '#ff4d4d', dark: '#b30000', glow: '#ff0000' }, // Red
                { main: '#4dff4d', dark: '#00b300', glow: '#00ff00' }, // Green
                { main: '#d24dff', dark: '#5600b3', glow: '#aa00ff' }, // Purple
                { main: '#ffaa4d', dark: '#b35900', glow: '#ff8800' }, // Orange
                { main: '#ff4da6', dark: '#b30059', glow: '#ff0080' }, // Pink
                { main: '#ffff00', dark: '#b3b300', glow: '#ffff66' }  // Yellow
            ];
            const p = palettes[Math.floor(Math.random() * palettes.length)];
            ball.style.background = `radial-gradient(circle at 30% 30%, ${p.main}, ${p.dark})`;
            ball.style.boxShadow = `0 0 15px ${p.glow}, 0 5px 15px rgba(0,0,0,0.4)`;
        }

        function setRandomOilPattern() {
            const patterns = [
                { name: '×¨×’×™×œ (Normal)', factor: 1.0, color: '#aaaaff' },
                { name: '×™×‘×© (Dry) - ×”×¨×‘×” ×¡×™×‘×•×‘', factor: 1.8, color: '#ffaa00' },
                { name: '×©×•×× ×™ (Oily) - ××¢×˜ ×¡×™×‘×•×‘', factor: 0.4, color: '#00ffaa' },
                { name: '×—×œ×§×œ×§ (Slippery)', factor: 0.1, color: '#00aaff' }
            ];
            const p = patterns[Math.floor(Math.random() * patterns.length)];
            currentOilFactor = p.factor;
            if (oilPatternDisplay) {
                oilPatternDisplay.textContent = "×ª×‘× ×™×ª ×©××Ÿ: " + p.name;
                oilPatternDisplay.style.color = p.color;
            }
            
        }

        function createSparks(x, y) {
            for (let i = 0; i < 8; i++) {
                const spark = document.createElement('div');
                spark.className = 'spark';
                spark.style.left = x + 'px';
                spark.style.top = y + 'px';
                const angle = Math.random() * Math.PI * 2;
                const dist = 20 + Math.random() * 30;
                spark.style.setProperty('--tx', Math.cos(angle) * dist + 'px');
                spark.style.setProperty('--ty', Math.sin(angle) * dist + 'px');
                spark.style.backgroundColor = ['#ffcc00', '#ffffff', '#ff0000'][Math.floor(Math.random()*3)];
                gameContainer.appendChild(spark);
                setTimeout(() => spark.remove(), 500);
            }
        }

        function createTrail() {
            if (Math.random() > 0.4) return; // ×œ× ×œ×™×¦×•×¨ ×‘×›×œ ×¤×¨×™×™×
            const dot = document.createElement('div');
            dot.className = 'trail-dot';
            // ××™×§×•× ×‘×ª×—×ª×™×ª ×”×›×“×•×¨
            const left = ballPosition + 25 - 4; 
            const top = parseInt(ball.style.top) + 40; 
            dot.style.left = left + 'px';
            dot.style.top = top + 'px';
            gameContainer.appendChild(dot);
            setTimeout(() => dot.remove(), 600);
        }

        // --- ×¡×¤×™×¨×” ×œ××—×•×¨ ---
        function updateCountdown() {
            const now = new Date();
            let targetYear = now.getFullYear();
            // ×ª××¨×™×š ×™×¢×“: 20 ×‘×¤×‘×¨×•××¨, 15:00 ×©×¢×•×Ÿ ×™×©×¨××œ (UTC+2 ×‘×—×•×¨×£)
            let targetDate = new Date(`${targetYear}-02-20T15:00:00+02:00`);
            
            let diff = targetDate - now;

            // ×‘×“×™×§×” ×× ×”×’×¢× ×• ×œ×ª××¨×™×š (××• ×¢×‘×¨× ×• ××•×ª×• ×‘×˜×•×•×— ×©×œ 24 ×©×¢×•×ª)
            if (diff < 0) {
                // ×× ×¢×‘×¨×• ×™×•×ª×¨ ×-24 ×©×¢×•×ª, ×¢×•×‘×¨×™× ×œ×©× ×” ×”×‘××”
                if (diff < -86400000) {
                    targetDate = new Date(`${targetYear + 1}-02-20T15:00:00+02:00`);
                    diff = targetDate - now;
                    birthdayCelebrated = false; // ××™×¤×•×¡ ×œ×©× ×” ×”×‘××”
                } else {
                    // ×–×”×• ×™×•× ×”×”×•×œ×“×ª! (×‘×˜×•×•×— ×©×œ 24 ×©×¢×•×ª)
                    if (!birthdayCelebrated) {
                        birthdayCelebrated = true;
                        showOverlay("ğŸ‰ ×™×•× ×”×•×œ×“×ª ×©××—! ğŸ‰");
                        // ×”×¤×¢×œ×ª ×§×•× ×¤×˜×™ ×‘×œ×•×œ××”
                        setInterval(fireConfetti, 300);
                        playSound('win');
                    }
                    
                    // ××™×¤×•×¡ ×”×©×¢×•×Ÿ ×œ-0
                    document.getElementById('cd-days').textContent = "00";
                    document.getElementById('cd-hours').textContent = "00";
                    document.getElementById('cd-minutes').textContent = "00";
                    document.getElementById('cd-seconds').textContent = "00";
                    return;
                }
            } else if (diff <= 0) {
                // ×¨×’×¢ ×”××¤×¡ ×‘×“×™×•×§
                document.getElementById('cd-days').textContent = "00";
                document.getElementById('cd-hours').textContent = "00";
                document.getElementById('cd-minutes').textContent = "00";
                document.getElementById('cd-seconds').textContent = "00";
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('cd-days').textContent = days < 10 ? '0' + days : days;
            document.getElementById('cd-hours').textContent = hours < 10 ? '0' + hours : hours;
            document.getElementById('cd-minutes').textContent = minutes < 10 ? '0' + minutes : minutes;
            document.getElementById('cd-seconds').textContent = seconds < 10 ? '0' + seconds : seconds;
        }

        function showOverlay(text, autoHideDuration = 0) {
            const overlay = document.getElementById('overlay-message');
            const txt = document.getElementById('overlay-text');
            txt.textContent = text;
            overlay.classList.add('visible');
            
            if (autoHideDuration > 0) {
                setTimeout(() => {
                    overlay.classList.remove('visible');
                }, autoHideDuration);
            }
        }

        // ×× ×™××¦×™×™×ª ×¤×ª×™×—×”
        window.addEventListener('load', () => {
            // ××¦×™×’ ×”×•×“×¢×” ×¨×§ ×× ×–×” ×œ× ×™×•× ×”×”×•×œ×“×ª ×›×¨×’×¢
            if (!birthdayCelebrated) {
                showOverlay("â³ ×”×¡×¤×™×¨×” ×œ××—×•×¨ ×”×—×œ×”! â³", 3000);
            }
        });

        setInterval(updateCountdown, 1000);
        updateCountdown(); // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª

        // ×¤×•× ×§×¦×™×™×ª ×§×•× ×¤×˜×™
        function fireConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.top = '-10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 2 + 1) + 's';
                document.body.appendChild(confetti);
                
                // ××—×™×§×” ××—×¨×™ ×©×”×× ×™××¦×™×” × ×’××¨×ª
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        // --- ×”×¤×¢×œ×ª ×”××©×—×§ ---
        setupPins();
        resetGame();
        // ×”×ª×—×œ×ª ×œ×•×œ××ª ×”×× ×™××¦×™×”
        if (!animationId) {
            gameLoop();
        }

    </script>
</body>
</html>